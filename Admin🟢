-- ===== SERVICES =====
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local Debris = game:GetService("Debris")

local lp = Players.LocalPlayer
local MY_NAME = lp.Name

-- ===== WHITELIST (ADMIN) =====
local WHITELIST = {
    ["robloxtestscrip_4"] = true, -- เพิ่มชื่อ admin
}

-- ===== UTILS =====
local function getChar()
    return lp.Character or lp.CharacterAdded:Wait()
end

local function isMe(name)
    name = string.lower(name or "")
    return name == string.lower(MY_NAME)
end

local function isAllowed(senderName)
    return WHITELIST[senderName] == true
end

-- ===== COMMAND ACTIONS =====
local function killMe()
    local h = getChar():FindFirstChildOfClass("Humanoid")
    if h then h.Health = 0 end
end

local function bringMe(senderName)
    local s = Players:FindFirstChild(senderName)
    local c = getChar()
    local hrp = c:FindFirstChild("HumanoidRootPart")
    if s and s.Character and hrp and s.Character:FindFirstChild("HumanoidRootPart") then
        hrp.CFrame = s.Character.HumanoidRootPart.CFrame * CFrame.new(0,0,-3)
    end
end

local function freezeMe()
    local hrp = getChar():FindFirstChild("HumanoidRootPart")
    if hrp then
        local bv = Instance.new("BodyVelocity")
        bv.Name = "FREEZE_CMD"
        bv.Velocity = Vector3.zero
        bv.MaxForce = Vector3.new(1e5,1e5,1e5)
        local tag = Instance.new("BoolValue")
        tag.Name="CMD_TAG"
        tag.Parent = bv
        bv.Parent = hrp
        hrp.Anchored = true
    end
end

local function unfreezeMe()
    local hrp = getChar():FindFirstChild("HumanoidRootPart")
    if hrp then
        local bv = hrp:FindFirstChild("FREEZE_CMD")
        if bv then bv:Destroy() end
        hrp.Anchored = false
    end
end

local function jailMe()
    local hrp = getChar():FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local old = workspace:FindFirstChild("JAIL_"..MY_NAME)
    if old then old:Destroy() end
    local cage = Instance.new("Part")
    cage.Name="JAIL_"..MY_NAME
    cage.Size=Vector3.new(8,8,8)
    cage.CFrame=hrp.CFrame
    cage.Anchored=true
    cage.CanCollide=true
    cage.Material=Enum.Material.Glass
    cage.Transparency=0.6
    cage.Color=Color3.fromRGB(120,200,255)
    cage.Parent=workspace
    hrp.CFrame=cage.CFrame
    freezeMe()
end

local function unjailMe()
    local old = workspace:FindFirstChild("JAIL_"..MY_NAME)
    if old then old:Destroy() end
    unfreezeMe()
end

local function explodeMe()
    local hrp = getChar():FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local ex = Instance.new("Explosion")
    ex.Position = hrp.Position
    ex.BlastRadius = 14
    ex.BlastPressure = 500000
    ex.DestroyJointRadiusPercent = 0
    ex.Parent = workspace
    local smoke = Instance.new("Smoke")
    smoke.Size = 25
    smoke.RiseVelocity = 10
    smoke.Opacity = 0.8
    smoke.Color = Color3.fromRGB(180,180,180)
    smoke.Parent = hrp
    Debris:AddItem(smoke,3)
end

-- ===== COMMAND HANDLER =====
local function handleCommand(text,senderName)
    if not isAllowed(senderName) then return end
    local lower = string.lower(text or "")
    local cmd,target = string.match(lower,"^;(%w+)%s*:%s*(.+)$")
    if not cmd then cmd,target=string.match(lower,"^(%w+)%s+(.+)$") end
    if not cmd or not isMe(target) then return end

    if cmd=="kill" then killMe()
    elseif cmd=="bring" then bringMe(senderName)
    elseif cmd=="freeze" then freezeMe()
    elseif cmd=="unfreeze" then unfreezeMe()
    elseif cmd=="jail" then jailMe()
    elseif cmd=="unjail" then unjailMe()
    elseif cmd=="explode" then explodeMe()
    end
end

lp.Chatted:Connect(function(msg) handleCommand(msg, MY_NAME) end)
pcall(function()
    TextChatService.MessageReceived:Connect(function(msg)
        local sender = msg.TextSource and msg.TextSource.Name or ""
        handleCommand(msg.Text, sender)
    end)
end)

-- ===== ADMIN UI =====
if WHITELIST[MY_NAME] then
    -- UI 1: Player List
    local guiPlayers = Instance.new("ScreenGui",game.CoreGui)
    guiPlayers.Name = "PlayerSelector"

    local frameP = Instance.new("Frame",guiPlayers)
    frameP.Size = UDim2.fromScale(0.25,0.4)
    frameP.Position = UDim2.fromScale(0.05,0.2)
    frameP.BackgroundColor3 = Color3.fromRGB(40,120,200)
    frameP.Active = true frameP.Draggable = true
    Instance.new("UICorner",frameP).CornerRadius = UDim.new(0,16)

    local titleP = Instance.new("TextLabel",frameP)
    titleP.Size = UDim2.fromScale(1,0.12)
    titleP.BackgroundTransparency = 1
    titleP.Text = "PLAYERS"
    titleP.TextColor3 = Color3.new(1,1,1)
    titleP.TextScaled = true
    titleP.Font = Enum.Font.GothamBold

    local SelectedPlayer = nil
    local function updatePlayerList()
        for _,v in ipairs(frameP:GetChildren()) do
            if v:IsA("TextButton") and v.Name=="PLAYERBTN" then v:Destroy() end
        end
        local y=0.14
        for _,plr in ipairs(Players:GetPlayers()) do
            local b = Instance.new("TextButton",frameP)
            b.Name="PLAYERBTN"
            b.Size = UDim2.fromScale(0.9,0.06)
            b.Position = UDim2.fromScale(0.05,y)
            y += 0.07
            b.Text = plr.Name
            b.TextScaled = true
            b.Font = Enum.Font.Gotham
            b.TextColor3 = Color3.new(1,1,1)
            b.BackgroundColor3 = Color3.fromRGB(20,90,160)
            b.BorderSizePixel = 0
            Instance.new("UICorner",b).CornerRadius = UDim.new(0,12)
            b.MouseButton1Click:Connect(function() SelectedPlayer = plr.Name end)
        end
    end
    updatePlayerList()
    Players.PlayerAdded:Connect(updatePlayerList)
    Players.PlayerRemoving:Connect(updatePlayerList)

    -- UI 2: Commands
    local guiCmd = Instance.new("ScreenGui",game.CoreGui)
    guiCmd.Name = "CommandPanel"

    local frameC = Instance.new("Frame",guiCmd)
    frameC.Size = UDim2.fromScale(0.25,0.45)
    frameC.Position = UDim2.fromScale(0.35,0.2)
    frameC.BackgroundColor3 = Color3.fromRGB(40,120,200)
    frameC.Active = true frameC.Draggable = true
    Instance.new("UICorner",frameC).CornerRadius = UDim.new(0,16)

    local titleC = Instance.new("TextLabel",frameC)
    titleC.Size = UDim2.fromScale(1,0.12)
    titleC.BackgroundTransparency = 1
    titleC.Text = "COMMANDS"
    titleC.TextColor3 = Color3.new(1,1,1)
    titleC.TextScaled = true
    titleC.Font = Enum.Font.GothamBold

    local commands={
        {name="KILL", cmd=";kill:"},
        {name="BRING", cmd=";bring:"},
        {name="FREEZE", cmd=";freeze:"},
        {name="UNFREEZE", cmd=";unfreeze:"},
        {name="JAIL", cmd=";jail:"},
        {name="UNJAIL", cmd=";unjail:"},
        {name="EXPLODE", cmd=";explode:"},
    }

    local yStart = 0.14
    for i,v in ipairs(commands) do
        local b = Instance.new("TextButton",frameC)
        b.Size = UDim2.fromScale(0.9,0.06)
        b.Position = UDim2.fromScale(0.05, yStart+(i-1)*0.07)
        b.Text = v.name
        b.TextScaled = true
        b.Font = Enum.Font.GothamBold
        b.TextColor3 = Color3.new(1,1,1)
        b.BackgroundColor3 = Color3.fromRGB(25,120,200)
        b.BorderSizePixel = 0
        Instance.new("UICorner",b).CornerRadius = UDim.new(0,12)
        b.MouseButton1Click:Connect(function()
            if SelectedPlayer then
                pcall(function()
                    TextChatService.TextChannels.RBXGeneral:SendAsync(v.cmd..SelectedPlayer)
                end)
            end
        end)
    end
end

print("SYSTEM READY")
